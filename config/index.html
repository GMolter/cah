<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CA(D)H – Config</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif;background:#0f1115;color:#e6e8ee;display:grid;place-items:center;height:100svh}
    .card{width:min(520px,92vw);background:#111319;border:1px solid #252936;border-radius:14px;padding:16px}
    .row{display:flex;gap:8px;margin:10px 0}
    input{flex:1;padding:10px;border-radius:10px;border:1px solid #2a2e39;background:#12141a;color:#fff}
    button{padding:10px 14px;border-radius:10px;border:1px solid #2a2e39;background:#1a1d24;color:#fff;cursor:pointer}
    .primary{background:#4f8cff;border-color:transparent}
    .muted{color:#9aa1af;font-size:12px}
    .log{white-space:pre-wrap;background:#0d0f14;border:1px solid #232733;border-radius:10px;padding:10px;height:180px;overflow:auto;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Config: Generate Room</h2>
    <div class="row">
      <input id="room-input" placeholder="4-digit code (auto)" />
      <button id="gen" class="primary">Generate</button>
    </div>
    <div class="row">
      <button id="reserve" class="primary">Reserve Room (and close others)</button>
      <button id="clear">Clear Local</button>
    </div>
    <p class="muted">After reserving, open <strong>index.html</strong>, enter the code, and Join.</p>
    <div id="log" class="log"></div>
  </div>

  <script type="module">
    const stamp = "CONFIG_BUILD 2025-09-01T06:12Z";
    const log = (m)=>{ const el = document.getElementById("log"); el.textContent += m + "\n"; el.scrollTop = el.scrollHeight; console.log(m); };
    log(stamp);

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, set, get, remove, child } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
    import { getAuth, setPersistence, browserLocalPersistence, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAe7u7Ij4CQUrWUDirzEZo0hyEPwjXO_uI",
      authDomain: "olio-cardsagainsthumanity.firebaseapp.com",
      projectId: "olio-cardsagainsthumanity",
      storageBucket: "olio-cardsagainsthumanity.firebasestorage.app",
      messagingSenderId: "256442998757",
      appId: "1:256442998757:web:ab26e55db0b5029879990c",
      databaseURL: "https://olio-cardsagainsthumanity-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const auth = getAuth(app);

    await setPersistence(auth, browserLocalPersistence);

    const authReady = new Promise((resolve, reject)=>{
      onAuthStateChanged(auth, async (u)=>{
        try{
          if(!u){
            log("[status] Signing in anonymously…");
            await signInAnonymously(auth);
            log("[status] Anonymous sign-in OK");
          }else{
            log("[status] Already signed in as " + u.uid);
          }
          resolve(true);
        }catch(e){
          log("[ERROR] signInAnonymously failed: " + (e?.message||e));
          reject(e);
        }
      }, (err)=>{ log("[ERROR] onAuthStateChanged: "+err); reject(err); });
    });

    const $ = (s)=> document.querySelector(s);
    const roomInput = $("#room-input");
    const gen = $("#gen");
    const reserve = $("#reserve");
    const clear = $("#clear");

    function fourDigit(){ return String(Math.floor(1000 + Math.random()*9000)); }

    gen.addEventListener("click", ()=>{
      roomInput.value = fourDigit();
      log("[gen] code = " + roomInput.value);
    });

    async function cleanupOtherRooms(keepCode){
      const uid = auth.currentUser.uid;
      const idxRef = ref(db, `hostRooms/${uid}`);
      try{
        const snap = await get(idxRef);
        if(!snap.exists()){ log("[cleanup] No other rooms to close."); return; }
        const entries = Object.keys(snap.val() || {});
        const others = entries.filter(c => c !== keepCode);
        if(!others.length){ log("[cleanup] No other rooms to close."); return; }

        log(`[cleanup] Closing ${others.length} room(s): ${others.join(", ")}`);
        for (const code of others){
          try{
            await remove(ref(db, `rooms/${code}`)); // allowed because rooms/$code .write permits hostUid
            await remove(ref(db, `hostRooms/${uid}/${code}`));
            log(`[cleanup] Closed room ${code}`);
          }catch(e){
            log(`[cleanup][ERROR] Failed to close ${code}: ${e?.message||e}`);
          }
        }
      }catch(e){
        log("[cleanup][ERROR] Could not list host rooms: " + (e?.message||e));
      }
    }

    reserve.addEventListener("click", async ()=>{
      await authReady;
      const code = (roomInput.value||"").trim() || fourDigit();
      roomInput.value = code;

      if(code.length !== 4){ log("[reserve] enter a 4-digit code"); return; }

      const uid = auth.currentUser.uid;
      try{
        await set(ref(db, `rooms/${code}/createdAt`), Date.now());
      }catch(e){
        log("[reserve] createdAt write (may already exist): " + (e?.message||e));
      }
      try{
        await set(ref(db, `rooms/${code}/hostUid`), uid);
      }catch(e){
        log("[reserve] hostUid write (may already exist): " + (e?.message||e));
      }
      try{
        await set(ref(db, `hostRooms/${uid}/${code}`), true);
      }catch(e){
        log("[reserve] hostRooms index write failed: " + (e?.message||e));
      }

      // mark me host locally
      localStorage.setItem("cadh-host","true");
      localStorage.setItem("cadh-room",code);
      localStorage.setItem("cadh-autojoin","true");

      log(`[reserve] Room ${code} reserved for host ${uid}.`);
      await cleanupOtherRooms(code);
      log("[done] Ready. Open main app with this code.");
    });

    clear.addEventListener("click", ()=>{
      localStorage.removeItem("cadh-host");
      localStorage.removeItem("cadh-room");
      localStorage.removeItem("cadh-name");
      localStorage.removeItem("cadh-autojoin");
      log("[local] cleared cadh-*");
    });

    // prefill
    roomInput.value = localStorage.getItem("cadh-room") || fourDigit();
  </script>
</body>
</html>
