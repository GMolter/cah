<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CA(D)H Config</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; min-height: 100dvh; display: grid; place-items: center; background: #0b0c10; color: #e3e3e3; }
    .card { width: 92vw; max-width: 560px; background: #111317; border: 1px solid #242834; border-radius: 16px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 8px; font-size: 22px; letter-spacing: .3px; }
    p  { margin: 0 0 16px; color: #a9b0be; }
    button { appearance: none; border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 600; background: #6ee7b7; color: #091015; cursor: pointer; }
    button:hover { filter: brightness(1.03); }
    .row { display: flex; gap: 10px; align-items: center; margin-top: 12px; }
    #status { margin-top: 14px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; color: #b7c1d6; white-space: pre-wrap; }
    input { width: 140px; padding: 10px 12px; border-radius: 10px; background: #0d1117; border: 1px solid #2a2f3a; color: #e3e3e3; }
    .muted { color: #7f8aa3; font-size: 12px; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Config: Global Host</h1>
    <p>Click “Create New Room” to become the <em>global host</em>, wipe other rooms, and create a fresh 4-digit room.</p>

    <div class="row">
      <button id="create">Create New Room</button>
      <input id="forceCode" type="text" maxlength="4" placeholder="(optional) 4-digit code" />
    </div>
    <div id="status"></div>
    <div class="muted">Stores <code>cadh-host=true</code> and <code>cadh-room=&lt;code&gt;</code> in localStorage.</div>
  </div>

  <script type="module">
    console.log("CONFIG_BUILD", new Date().toISOString());

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, set, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

    // === YOUR CREDS (exactly as you provided) ===
    const firebaseConfig = {
      apiKey: "AIzaSyAe7u7Ij4CQUrWUDirzEZo0hyEPwjXO_uI",
      authDomain: "olio-cardsagainsthumanity.firebaseapp.com",
      projectId: "olio-cardsagainsthumanity",
      storageBucket: "olio-cardsagainsthumanity.appspot.com",
      messagingSenderId: "256442998757",
      appId: "1:256442998757:web:ab26e55db0b5029879990c",
      databaseURL: "https://olio-cardsagainsthumanity-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const $ = (s)=>document.querySelector(s);
    const status = $("#status");
    const btn = $("#create");
    const forceCode = $("#forceCode");

    function say(msg){
      console.log("[status]", msg);
      status.textContent = msg;
    }

    function fourDigitsRandom(){
      return Math.floor(1000 + Math.random()*9000).toString();
    }

    function validCode(v){
      return /^[0-9]{4}$/.test(v);
    }

    btn.addEventListener("click", async ()=>{
      try{
        say("Signing in…");
        const cred = await signInAnonymously(auth);
        say("Signed in");

        // Claim global host
        say("Claiming global host flag…");
        await set(ref(db, "control/globalHostUid"), cred.user.uid);

        // Delete ALL rooms (per rules, only current globalHostUid may write at /rooms)
        say("Deleting existing rooms…");
        await remove(ref(db, "rooms"));

        // Generate (or use forced) numeric code
        const codeInput = (forceCode.value || "").trim();
        const code = validCode(codeInput) ? codeInput : fourDigitsRandom();

        // Create fresh room
        say("Creating room " + code + "…");
        await set(ref(db, `rooms/${code}`), {
          createdAt: Date.now(),
          hostUid: cred.user.uid
        });

        // Persist local host state
        localStorage.setItem("cadh-host", "true");
        localStorage.setItem("cadh-room", code);

        say("✅ Room created: " + code + "\nOpen main page and join with this code.");
        console.log("[config] SUCCESS code =", code);
      }catch(err){
        console.error("[config] FAILED", err);
        say("FAILED: " + (err?.message || err));
      }
    });
  </script>
</body>
</html>
