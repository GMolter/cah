<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CAH Config (Admin)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0e0e0e;--card:#141414;--text:#fff;--muted:#a8a8a8;--ring:#2a2a2a;--ok:#15c27f;--err:#ff6b6b;--accent:#b4002b}
    *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif}
    main{max-width:980px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 12px} h2{margin:0 0 12px;font-size:18px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 8px 28px rgba(0,0,0,.45);margin:12px 0}
    input,button{font:inherit}
    input{padding:10px;border-radius:10px;border:1px solid var(--ring);background:#0b0b0b;color:#fff}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.primary{background:#fff;color:#000} button.ghost{background:#1f1f1f;color:#fff}
    button.danger{background:var(--accent);color:#fff}
    small.muted{color:var(--muted)} .badge{padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
    .ok{background:rgba(21,194,127,.12);color:#7ef1c1} .err{background:rgba(255,107,107,.12);color:#ffc9c9}
    .toasts{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:10}
    .toast{background:#1a1a1a;color:#e6e6e6;padding:10px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .user-card{border:1px solid #1f1f1f;border-radius:12px;padding:12px;display:flex;justify-content:space-between;gap:12px;align-items:center}
    .user-meta{display:flex;flex-direction:column;gap:2px}
    .dim{color:#bcbcbc;font-size:12px}
    .inline{display:inline-flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <main>
    <h1>CAH Config</h1>

    <!-- Non-admin view -->
    <section id="blocked" class="card" style="display:none">
      <h2>Admin Area</h2>
      <p class="muted">You don’t have access to this page.</p>
      <div class="row">
        <a href="../" class="ghost" style="text-decoration:none"><button class="ghost">← Back to Lobby</button></a>
      </div>
    </section>

    <!-- Admin view -->
    <section id="adminWrap" style="display:none">
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Welcome, <span id="whoami">Admin</span> <span class="badge ok">admin</span></h2>
          <a href="../" class="ghost" style="text-decoration:none"><button class="ghost">← Back to Lobby</button></a>
        </div>
        <small class="muted">Root admin (<code>gmolter8@gmail.com</code>) is permanently admin and cannot be banned or demoted by others.</small>
      </section>

      <!-- Search -->
      <section class="card">
        <h2>User Search</h2>
        <div class="row">
          <input id="q" placeholder="Search by email or nickname" style="min-width:260px;flex:1"/>
          <button id="searchBtn" class="primary">Search</button>
          <button id="refreshAll" class="ghost">Refresh All</button>
        </div>
        <div id="results" class="grid" style="margin-top:10px"></div>
        <small class="muted">Search results are from <code>/profiles</code>. Clicking actions below uses <code>/admins/uids</code> and <code>/bans/uids</code>.</small>
      </section>

      <!-- Rooms -->
      <section class="card">
        <h2>Room Settings</h2>
        <div class="grid">
          <div class="card">
            <h2>Room 1</h2>
            <div class="row"><label><input type="checkbox" id="r1Private"> Private</label></div>
            <div class="row" style="margin-top:6px"><input id="r1Pwd" type="text" placeholder="password (leave blank to keep current)" style="flex:1"/></div>
            <div class="row" style="margin-top:8px">
              <button id="saveR1" class="primary">Save Room 1</button>
              <button id="clearR1" class="ghost">Clear Password (Public)</button>
            </div>
            <small id="r1Status" class="muted"></small>
          </div>

          <div class="card">
            <h2>Room 2</h2>
            <div class="row"><label><input type="checkbox" id="r2Private"> Private</label></div>
            <div class="row" style="margin-top:6px"><input id="r2Pwd" type="text" placeholder="password (leave blank to keep current)" style="flex:1"/></div>
            <div class="row" style="margin-top:8px">
              <button id="saveR2" class="primary">Save Room 2</button>
              <button id="clearR2" class="ghost">Clear Password (Public)</button>
            </div>
            <small id="r2Status" class="muted"></small>
          </div>
        </div>
      </section>
    </section>
  </main>

  <div class="toasts" id="toasts"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const ROOT_EMAIL = "gmolter8@gmail.com";

    const firebaseConfig = {
      apiKey: "AIzaSyAe7u7Ij4CQUrWUDirzEZo0hyEPwjXO_uI",
      authDomain: "olio-cardsagainsthumanity.firebaseapp.com",
      projectId: "olio-cardsagainsthumanity",
      storageBucket: "olio-cardsagainsthumanity.firebasestorage.app",
      messagingSenderId: "256442998757",
      appId: "1:256442998757:web:ab26e55db0b5029879990c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app, "https://olio-cardsagainsthumanity-default-rtdb.firebaseio.com/");
    const $ = q => document.querySelector(q);
    const toast = (t, ms=2600) => { const w=$("#toasts"); const d=document.createElement("div"); d.className="toast"; d.textContent=t; w.appendChild(d); setTimeout(()=>d.remove(), ms); };

    // page mode: admin or not
    onAuthStateChanged(auth, async (u) => {
      // No sign-in UI here. If not authed, block page.
      if (!u) { $("#blocked").style.display = ""; return; }

      // Is admin? root email is always admin regardless of DB
      let isAdmin = (u.email === ROOT_EMAIL);
      if (!isAdmin) {
        try {
          const s = await get(ref(db, "admins/uids/" + u.uid));
          isAdmin = s.val() === true;
        } catch {}
      }

      if (!isAdmin) { $("#blocked").style.display = ""; return; }

      // admin UI
      $("#blocked").style.display = "none";
      $("#adminWrap").style.display = "";
      $("#whoami").textContent = u.email || u.uid;

      // Load room settings summaries (no passwords shown)
      await loadRoom("room1");
      await loadRoom("room2");

      // Search handlers
      $("#searchBtn").onclick = searchProfiles;
      $("#refreshAll").onclick = searchProfiles;
    });

    // ---- Search ----
    async function searchProfiles(){
      const term = ($("#q").value || "").trim().toLowerCase();
      const results = $("#results"); results.innerHTML = "";
      try{
        const snap = await get(ref(db, "profiles"));
        const all = snap.val() || {};
        const arr = Object.entries(all).map(([uid,p])=>({uid, email:p?.email||"", nickname:p?.nickname||p?.firstName||""}));
        const filtered = term ? arr.filter(u => (u.email.toLowerCase().includes(term) || (u.nickname||"").toLowerCase().includes(term))) : arr.slice(0,12);
        if(filtered.length===0){ results.innerHTML = "<small class='muted'>No users found.</small>"; return; }
        for(const u of filtered){ results.appendChild(await renderUserCard(u)); }
      }catch(e){ toast("Failed to search profiles"); }
    }

    async function renderUserCard(user){
      const card = document.createElement("div"); card.className="user-card";
      const meta = document.createElement("div"); meta.className="user-meta";
      meta.innerHTML = `
        <div class="inline"><strong>${user.nickname || "(no nickname)"} </strong> <span class="dim">${user.email}</span></div>
        <div class="dim">UID: ${user.uid}</div>
      `;
      const actions = document.createElement("div"); actions.className="row";
      const btnAdd = btn("Add Admin","primary",()=> setAdmin(user.uid,true));
      const btnRem = btn("Remove Admin","ghost",()=> setAdmin(user.uid,false));
      const btnBan = btn("Ban","danger",()=> setBan(user.uid,true));
      const btnUnb = btn("Unban","ghost",()=> setBan(user.uid,false));
      actions.append(btnAdd,btnRem,btnBan,btnUnb);
      card.append(meta,actions);
      return card;
    }
    function btn(t,cls,fn){ const b=document.createElement("button"); b.textContent=t; b.className=cls; b.onclick=fn; return b; }

    async function setAdmin(uid,val){
      // prevent anyone except root from touching root admin account
      try{
        const prof = await get(ref(db, "profiles/" + uid));
        const email = (prof.val() && prof.val().email) || "";
        if (email === ROOT_EMAIL && val === false){ toast("Root admin cannot be demoted."); return; }
      }catch{}
      try{
        if(val) await set(ref(db, "admins/uids/" + uid), true);
        else    await remove(ref(db, "admins/uids/" + uid));
        toast(val?"Admin added":"Admin removed");
      }catch(e){ toast(e.code==="PERMISSION_DENIED"?"Not allowed":(e.message||"Update failed")); }
    }

    async function setBan(uid,val){
      // cannot ban root
      try{
        const prof = await get(ref(db, "profiles/" + uid));
        const email = (prof.val() && prof.val().email) || "";
        if (email === ROOT_EMAIL){ toast("Root admin cannot be banned."); return; }
      }catch{}
      try{
        if(val) await set(ref(db, "bans/uids/" + uid), true);
        else    await remove(ref(db, "bans/uids/" + uid));
        toast(val?"User banned":"User unbanned");
      }catch(e){ toast(e.code==="PERMISSION_DENIED"?"Not allowed":(e.message||"Update failed")); }
    }

    // ---- Rooms ----
    function bindRoomControls(room, chkId, pwdId, saveBtnId, clearBtnId, statusId){
      document.querySelector(saveBtnId).onclick = async ()=>{
        const priv = document.querySelector(chkId).checked;
        const pwd  = document.querySelector(pwdId).value.trim();
        const updates = { private: !!priv };
        if (pwd.length > 0) updates.password = pwd;
        try{
          await update(ref(db, `rooms/${room}/settings`), updates);
          document.querySelector(statusId).textContent = "Saved ✓";
          document.querySelector(pwdId).value = "";
        }catch(e){ document.querySelector(statusId).textContent = "Save failed"; }
      };
      document.querySelector(clearBtnId).onclick = async ()=>{
        try{
          await update(ref(db, `rooms/${room}/settings`), { private: false, password: null });
          document.querySelector(chkId).checked = false;
          document.querySelector(pwdId).value = "";
          document.querySelector(statusId).textContent = "Password cleared (public)";
        }catch(e){ document.querySelector(statusId).textContent = "Clear failed"; }
      };
    }

    async function loadRoom(room){
      const map = {
        "room1": { chk:"#r1Private", pwd:"#r1Pwd", save:"#saveR1", clear:"#clearR1", stat:"#r1Status" },
        "room2": { chk:"#r2Private", pwd:"#r2Pwd", save:"#saveR2", clear:"#clearR2", stat:"#r2Status" }
      }[room];
      bindRoomControls(room, map.chk, map.pwd, map.save, map.clear, map.stat);
      try{
        const s = await get(ref(db, `rooms/${room}/settings`));
        const v = s.val() || {};
        if (typeof v.private === "boolean") document.querySelector(map.chk).checked = v.private;
        document.querySelector(map.stat).textContent = v.private ? "Currently private" : "Currently public";
      }catch{}
    }
  </script>
</body>
</html>
