<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>CA(D)H — Config</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;background:#0b0e18;color:#e8ebff;font:16px system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif}
    main{max-width:680px;margin:40px auto;padding:20px;background:#121829;border:1px solid #223; border-radius:14px}
    h1{margin:0 0 12px}
    button{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(180deg,#6ea8ff,#8bdeff);color:#001;font-weight:800;cursor:pointer}
    code{background:#0c1020;padding:2px 6px;border-radius:6px}
    .row{display:flex;gap:10px;margin-top:10px}
    input{flex:1;padding:10px;border-radius:10px;border:1px solid #233;background:#0b0e18;color:#e8ebff}
    .log{white-space:pre-wrap;background:#0c1020;border:1px solid #233;padding:10px;border-radius:10px;margin-top:12px;height:200px;overflow:auto}
  </style>
</head>
<body>
  <main>
    <h1>Config: generate room</h1>
    <p id="status">[status] Boot…</p>
    <div class="row">
      <input id="code" placeholder="Room code" />
      <button id="gen">Generate 4-digit</button>
    </div>
    <div class="row">
      <button id="create">Create room</button>
      <button id="open">Open main page</button>
    </div>
    <div class="log" id="log"></div>
  </main>

  <script type="module">
    const log = (...a)=>{ const el=document.getElementById('log'); el.textContent += a.join(' ') + "\n"; el.scrollTop = el.scrollHeight; console.log(...a); };
    const status = (t)=> { document.getElementById('status').textContent = t; log(t); };

    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    status("CONFIG_BUILD " + new Date().toISOString().slice(0,16).replace('T',' ') + "Z");
    const app = initializeApp({
      apiKey: "AIzaSyAe7u7Ij4CQUrWUDirzEZo0hyEPwjXO_uI",
      authDomain: "olio-cardsagainsthumanity.firebaseapp.com",
      databaseURL: "https://olio-cardsagainsthumanity-default-rtdb.firebaseio.com",
      projectId: "olio-cardsagainsthumanity",
      storageBucket: "olio-cardsagainsthumanity.firebasestorage.app",
      messagingSenderId: "256442998757",
      appId: "1:256442998757:web:ab26e55db0b5029879990c",
    });
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Sign in ASAP
    status("[status] Signing in anonymously…");
    const ready = new Promise((res,rej)=>{
      onAuthStateChanged(auth, (u)=>{ if(u){ log("[auth] uid", u.uid); res(u);} }, (e)=>rej(e));
      signInAnonymously(auth).catch(e=>{ log("[auth] signIn error", e.message); rej(e); });
    });

    // UI
    const $ = (s)=> document.querySelector(s);
    $("#gen").onclick = ()=>{
      const code = Math.floor(1000 + Math.random()*9000).toString(36).toUpperCase().slice(0,4).padEnd(4,'X');
      $("#code").value = code;
      log("[gen] code =", code);
    };
    $("#open").onclick = ()=>{
      const code = ($("#code").value||"").toUpperCase();
      if(!code) return;
      window.open(`../index.html?room=${code}`, "_blank");
    };
    $("#create").onclick = async ()=>{
      const code = ($("#code").value||"").toUpperCase();
      if(!code) return alert("Enter code");
      const u = await ready;
      status("[create] writing room nodes…");
      try{
        await set(ref(db, `rooms/${code}/hostUid`), u.uid);
        await set(ref(db, `rooms/${code}/createdAt`), Date.now());
        log("[create] OK. Open main page.");
        localStorage.setItem("cadh-room", code);
        localStorage.setItem("cadh-name", "Host");
      }catch(e){
        log("[create] FAILED", e.message);
        alert("Create failed: "+e.message);
      }
    };
  </script>
</body>
</html>
