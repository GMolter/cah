<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CA(D)H Config</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <div id="config">
    <h1>Config Page</h1>
    <button id="create-room">Create New Room</button>
    <div id="status"></div>
  </div>

  <script type="module">
    console.log("CONFIG_BUILD", new Date().toISOString());

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, set, remove, get, child } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAe7u7Ij4CQUrWUDirzEZo0hyEPwjXO_uI",
      authDomain: "olio-cardsagainsthumanity.firebaseapp.com",
      projectId: "olio-cardsagainsthumanity",
      storageBucket: "olio-cardsagainsthumanity.appspot.com",
      messagingSenderId: "256442998757",
      appId: "1:256442998757:web:ab26e55db0b5029879990c",
      databaseURL: "https://olio-cardsagainsthumanity-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const status = document.getElementById("status");
    const btn = document.getElementById("create-room");

    function log(msg) {
      console.log("[status]", msg);
      status.textContent = msg;
    }

    async function createRoom() {
      log("Signing in…");
      const userCred = await signInAnonymously(auth);
      log("Signed in");

      // Delete existing rooms
      log("Deleting existing rooms…");
      try {
        await remove(ref(db, "rooms"));
        log("Old rooms deleted");
      } catch (e) {
        console.error("[config] delete rooms FAILED", e);
        log("FAILED deleting rooms: " + e);
        return;
      }

      // Generate numeric code
      const code = Math.floor(1000 + Math.random() * 9000).toString();

      // Create base room
      const roomRef = ref(db, `rooms/${code}`);
      await set(roomRef, {
        createdAt: Date.now(),
        hostUid: userCred.user.uid
      });

      localStorage.setItem("cadh-room", code);
      localStorage.setItem("cadh-host", "true");

      log("Room created with code: " + code);
    }

    btn.addEventListener("click", createRoom);
  </script>
</body>
</html>
