<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>CA(D)H Config</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{margin:0;background:#0b0b0f;color:#fff;font:16px/1.5 system-ui,Segoe UI,Roboto}
    .wrap{max-width:700px;margin:8vh auto;padding:24px;border:1px solid #272738;border-radius:14px;background:#13131a}
    h1{margin:0 0 6px}
    p{color:#b8b8c6}
    .row{display:flex;gap:10px;margin:16px 0}
    .btn{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;background:#2a2a3a;color:#fff}
    .btn-primary{background:linear-gradient(90deg,#6e8bff,#9f67ff)}
    .out{white-space:pre-wrap;background:#0f0f17;border:1px solid #272738;border-radius:10px;padding:10px;min-height:60px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#1b1b28; padding:2px 6px; border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Config • Create 4-Digit Room</h1>
    <p>This page signs in anonymously, deletes existing rooms, and creates a new 4-digit room with you as host.</p>
    <div class="row">
      <button id="create" class="btn btn-primary">Create New Room</button>
      <button id="open" class="btn">Open Main App</button>
    </div>
    <div id="status" class="out">CONFIG_BUILD <span id="ts"></span></div>
  </div>

  <script type="module">
    import { authReady, db, ref, get, set, remove } from "../firebase.js";

    const ts = new Date().toISOString();
    document.getElementById("ts").textContent = ts;

    const status = (msg)=> {
      const el = document.getElementById("status");
      el.textContent += "\\n" + msg;
      el.scrollTop = el.scrollHeight;
      console.log("[status]", msg);
    };

    function randomCode(){ return String(Math.floor(1000 + Math.random()*9000)); }

    async function create(){
      try{
        status("Signing in…");
        const user = await authReady;
        status("Signed in: " + user.uid);

        // Delete each room individually (root delete may be denied by rules)
        status("Deleting existing rooms…");
        const roomsSnap = await get(ref(db, "rooms"));
        if (roomsSnap.exists()) {
          const rooms = roomsSnap.val();
          const codes = Object.keys(rooms);
          for (const c of codes) {
            try {
              await remove(ref(db, `rooms/${c}`));
              status(`Deleted room ${c}`);
            } catch (e) {
              status(`Could not delete room ${c}: ${e?.message || e}`);
            }
          }
        } else {
          status("No rooms found.");
        }

        // Create new
        const code = randomCode();
        await set(ref(db, `rooms/${code}`), {
          hostUid: user.uid,
          createdAt: Date.now(),
          started: false
        });
        status("Created room " + code);

        // Save a convenience session for main app (host name is arbitrary)
        localStorage.setItem("cadh:session", JSON.stringify({ code, name: "Host" }));

        status("Done. Open the main app and join as Host.");
      }catch(e){
        console.error("[config] FAILED", e);
        status("Error: " + (e?.message || e));
      }
    }

    document.getElementById("create").onclick = create;
    document.getElementById("open").onclick = ()=> location.href = "../index.html";
  </script>
</body>
</html>
